package combat;

import java.awt.event.ActionEvent;
import java.awt.event.ActionListener;
import java.util.HashMap;

import javax.swing.Timer;

import org.bukkit.ChatColor;
import org.bukkit.entity.LivingEntity;
import org.bukkit.entity.Player;
import org.bukkit.potion.PotionEffect;
import org.bukkit.potion.PotionEffectType;

import custom.Clock;

public class Resistance implements ActionListener {
	private static final PotionEffectType RESISTANCE = PotionEffectType.DAMAGE_RESISTANCE;
	private final LivingEntity target;
	private final Timer buffTimer, debuffTimer;
	private Clock buffClock, debuffClock, appleClock;
	private int buffStacks, debuffStacks, effectDuration, appleDuration;
	private static HashMap<LivingEntity, Resistance> resistances = new HashMap<LivingEntity, Resistance>();

	public Resistance(LivingEntity target) {
		this.target = target;
		effectDuration = 0;
		
		buffStacks = 0;
		buffTimer = new Timer(10000, this);
		buffTimer.setRepeats(false);
		buffTimer.setActionCommand("buff");
		buffClock = new Clock();

		debuffStacks = 0;
		debuffTimer = new Timer(10000, this);
		debuffTimer.setRepeats(false);
		debuffTimer.setActionCommand("debuff");	
		debuffClock = new Clock();
		
		appleClock = new Clock();
		appleDuration = 0;
		
		resistances.put(target, this);
	}

	@Override
	public void actionPerformed(ActionEvent event) {
		switch (event.getActionCommand()) {
		case "buff":
			buffStacks = 0;
			if (target instanceof Player) {
				Player player = (Player) target;
				player.sendMessage(ChatColor.GREEN + "Buff Fell Off");
			}
			break;
		case "debuff":
			debuffStacks = 0;
			if (target instanceof Player) {
				Player player = (Player) target;
				player.sendMessage(ChatColor.RED + "Debuff Fell Off");
			}
			break;
		default:
			break;
		}

		int amplifier = debuffStacks + buffStacks;
		
		if (appleDuration - appleClock.getTicks() > 0) {
			amplifier++;
		}
		
		if (target instanceof Player) {
			Player player = (Player) target;
			player.sendMessage("Rank " + amplifier);
		}
		
		
		else {
			if (appleDuration - appleClock.getTicks() > 0) {
				PotionEffect effect = new PotionEffect(RESISTANCE, (int) (appleDuration - appleClock.getTicks()), 0);
				((Player) target).sendMessage("" + effect.getDuration());
				target.addPotionEffect(effect);
			}			
		}
		resistances.remove(target);
	}
	
	private PotionEffect getEffect() {
		switch (stacks + buff + godApple > 0? 1 : 0) {
		case 1:
			return new PotionEffect(RESISTANCE, 200, 0);
		case 0:
			return new PotionEffect(RESISTANCE, 0, 0);
		default:
			return new PotionEffect(RESISTANCE, 200, stacks);
		}
	}
	
	private void checkForApple() {
		appleClock.reset();
		for(PotionEffect effect : target.getActivePotionEffects()) {
			if (effect.getType().equals(RESISTANCE)) {
				if (effect.getAmplifier() == 0) {
					if (effect.getDuration() > 200) {
						appleDuration = effect.getDuration();
					}
				}
			}
		}
	}
	
	
	private void debuff() {
		if (target instanceof Player) {
			Player player = (Player) target;
			player.sendMessage(ChatColor.RED + "Debuff");
		}
		checkForApple();
		debuffStacks--;
		debuffClock.reset();
		debuffTimer.restart();
		actionPerformed(new ActionEvent(this, 0, "refresh"));	
	}
	
	private void buff() {		
		if (target instanceof Player) {
			Player player = (Player) target;
			player.sendMessage(ChatColor.GREEN + "Buff");
		}
		checkForApple();
		buffStacks = 1;
		buffClock.reset();
		buffTimer.restart();
		actionPerformed(new ActionEvent(this, 0, "refresh"));
	}

	public static void debuff(LivingEntity target) {
		if (resistances.containsKey(target) == false) {
			resistances.put(target, new Resistance(target));
		}		
		resistances.get(target).debuff();
	}

	public static void buff(LivingEntity target) {
		if (resistances.containsKey(target) == false) {
			resistances.put(target, new Resistance(target));
		}
		resistances.get(target).buff();
	}
}
