package industry;

import java.util.Random;
import org.bukkit.Location;
import org.bukkit.Material;
import org.bukkit.World;
import org.bukkit.block.Block;
import org.bukkit.entity.Entity;
import org.bukkit.entity.EntityType;
import org.bukkit.entity.LivingEntity;
import org.bukkit.entity.Player;
import org.bukkit.inventory.ItemStack;

import skills.Skill;
import skills.SkillType;
import skills.SkillHandler;

public class Farming extends Skill {

	public Farming(Player player, int level, int exp) {
		super(player, level, exp);
	}

	@Override
	public void info() {
		super.info();
		message(1, "Work in progress");
		message(250, "Passive: " + level/10 + "% chance for double drop");
		message(250, "Level 250 Passive: Crops grow faster");
		message(750, "Level 750 Passive: Extra food value from crops.");
	}

	private static void convertSeeds(Block block) {
		switch (block.getType()) {
		case COBBLESTONE:
			block.setType(Material.MOSSY_COBBLESTONE);
			break;
		case COBBLE_WALL:
			block.setData((byte) 1);
			break;
		case STONE:
			block.setData((byte) 1);
			break;
		case DIRT:
			block.setType(Material.GRASS);
			break;
		default:
			break;
		}
	}

	public static void active(Player player, Block block) {
		double chance = new Random().nextDouble();
		Material item = player.getItemInHand().getType();
		switch (item) {
		case SEEDS:
			switch (block.getType()) {
			case COBBLESTONE:
			case DIRT:
			case STONE:
				reduceHand(player);
				if (chance <= 0.1) {
					convertSeeds(block);
				}
				else {
					block.setType(Material.AIR);
				}
			default:
				break;
			}
			break;
		case BROWN_MUSHROOM:
			if (block == null) {
				block = player.getTargetBlock(null, 5);
			}
			if (block.getType().equals(Material.DIRT) || block.getType().equals(Material.GRASS)) {
				reduceHand(player);
				if (chance <= 0.1) {
					block.setType(Material.MYCEL);
				}
				else {
					block.setType(Material.AIR);
				}
			}
		default:
			break;
		}
	}

	public static void active(Player player, Entity entity) {		
		if (entity.getType().equals(EntityType.COW)) {
			if (player.getItemInHand().getType().equals(Material.RED_MUSHROOM)) {
				double chance = new Random().nextDouble();
				reduceHand(player);
				if (chance <= 0.1) {
					World world = entity.getWorld();
					Location spawn = entity.getLocation();
					world.spawnEntity(spawn, EntityType.MUSHROOM_COW);
				}
				else {
					((LivingEntity) entity).setHealth(0.0);
				}
			}
		}
	}

	private static void reduceHand(Player player) {
		if (player.getItemInHand().getAmount() - 1 == 0) {
			player.setItemInHand(null);
		}
		else {
			int amount = player.getItemInHand().getAmount() - 1;
			player.getItemInHand().setAmount(amount);
		}
	}

	public static void blockBreak(Player player, Block block) {
		Skill farming = SkillHandler.getSkill(player, SkillType.FARMING);
		farming.addExp(getExp(block));
		double chance = farming.level() / 10;
		boolean proc = new Random().nextDouble() <= chance;
		if (proc) {
			World world = block.getWorld();
			Location location = block.getLocation();
			for(ItemStack drop : block.getDrops()) {
				world.dropItemNaturally(location, drop);
			}
		}
	}			

	public static void blockPlace(Player player, Block block) {
		int level = SkillHandler.getSkill(player, SkillType.FARMING).level();
		if (level >= 250) {
			switch (block.getType()) {
			case CROPS:
			case CARROT:
			case POTATO:
				block.setData((byte) 7);
				break;
			case NETHER_WARTS:
				block.setData((byte) 3);
				break;
			default:
				break;
			}

		}
	}

	public static void itemConsume(Player player, ItemStack food) {
		int level = SkillHandler.getSkill(player, SkillType.FARMING).level();
		if (level >= 750) {
			int hunger = player.getFoodLevel();
			float saturation = player.getSaturation();
			switch (food.getType()) {
			case CARROT_ITEM:
				player.setFoodLevel(hunger + 4);
				player.setSaturation(saturation + 4.8f);
				break;
			case POTATO_ITEM:
				player.setFoodLevel(hunger + 1);
				player.setSaturation(saturation + 0.6f);
				break;
			case BREAD:
				player.setFoodLevel(hunger + 5);
				player.setSaturation(saturation + 6f);
				break;
			default:
				break;			
			}
		}
	}

	public static boolean isCrop(Block block) {
		switch (block.getType()) {
		case CROPS:
		case NETHER_WARTS:
		case POTATO:
		case CARROT:
			return isGrown(block);
		case PUMPKIN:
		case MELON_BLOCK:		
		case SUGAR_CANE_BLOCK:
		case CACTUS:		
			return true;
		default:
			return false;
		}
	}

	private static boolean isGrown(Block block) {
		switch (block.getType()) {
		case CROPS:
		case POTATO:
		case CARROT:
			return block.getData() == 7;
		case NETHER_WARTS:
			return block.getData() == 3;
		default:
			return true;
		}
	}

	private static int getExp(Block block) {
		switch (block.getType()) {
		case CROPS:
		case POTATO:
		case CARROT:
		case NETHER_WARTS:
		case MELON_BLOCK:
		case PUMPKIN:
			return 10;
		case CACTUS:
			return 10 * checkBlocks(block, Material.CACTUS);
		case SUGAR_CANE_BLOCK:
			return 5 * checkBlocks(block, Material.SUGAR_CANE_BLOCK);
		default:
			return 0;
		}
	}

	private static int checkBlocks(Block block, Material material) {
		if (block.getType().equals(material)) {
			return 1 + checkBlocks(block.getRelative(0, 1, 0), material);
		}
		return 0;
	}
}
